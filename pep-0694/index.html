
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>PEP 694 – Upload 2.0 API for Python Package Indexes | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png">
    <link rel="canonical" href="https://peps.python.org/pep-0694/">
    <link rel="stylesheet" href="../_static/style.css" type="text/css">
    <link rel="stylesheet" href="../_static/mq.css" type="text/css">
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light">
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark">
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://peps.python.org/peps.rss">
    <meta property="og:title" content='PEP 694 – Upload 2.0 API for Python Package Indexes | peps.python.org'>
    <meta property="og:description" content="This PEP proposes a standard API for uploading files to a Python package index such as PyPI.  Along with standardization, the upload API provides additional useful features such as support for:">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://peps.python.org/pep-0694/">
    <meta property="og:site_name" content="Python Enhancement Proposals (PEPs)">
    <meta property="og:image" content="https://peps.python.org/_static/og-image.png">
    <meta property="og:image:alt" content="Python PEPs">
    <meta property="og:image:width" content="200">
    <meta property="og:image:height" content="200">
    <meta name="description" content="This PEP proposes a standard API for uploading files to a Python package index such as PyPI.  Along with standardization, the upload API provides additional useful features such as support for:">
    <meta name="theme-color" content="#3776ab">
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 694</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg aria-hidden="true" class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg aria-hidden="true" class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
                <span class="visually-hidden">Toggle light / dark / auto colour theme</span>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 694 – Upload 2.0 API for Python Package Indexes</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Barry Warsaw &lt;barry&#32;&#97;t&#32;python.org&gt;, Donald Stufft &lt;donald&#32;&#97;t&#32;stufft.io&gt;</dd>
<dt class="field-even">Discussions-To<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="https://discuss.python.org/t/pep-694-upload-2-0-api-for-python-package-repositories/16879">Discourse thread</a></dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><abbr title="Proposal under active discussion and revision">Draft</abbr></dd>
<dt class="field-even">Type<span class="colon">:</span></dt>
<dd class="field-even"><abbr title="Normative PEP with a new feature for Python, implementation change for CPython or interoperability standard for the ecosystem">Standards Track</abbr></dd>
<dt class="field-odd">Topic<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="../topic/packaging/">Packaging</a></dd>
<dt class="field-even">Created<span class="colon">:</span></dt>
<dd class="field-even">11-Jun-2022</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://discuss.python.org/t/pep-694-upload-2-0-api-for-python-package-repositories/16879" title="Discourse thread">27-Jun-2022</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#legacy-api">Legacy API</a><ul>
<li><a class="reference internal" href="#endpoint">Endpoint</a></li>
<li><a class="reference internal" href="#encoding">Encoding</a></li>
<li><a class="reference internal" href="#content">Content</a></li>
<li><a class="reference internal" href="#authentication">Authentication</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upload-2-0-api-specification">Upload 2.0 API Specification</a><ul>
<li><a class="reference internal" href="#versioning">Versioning</a></li>
<li><a class="reference internal" href="#root-endpoint">Root Endpoint</a><ul>
<li><a class="reference internal" href="#create-an-upload-session">Create an Upload Session</a><ul>
<li><a class="reference internal" href="#response-body">Response Body</a></li>
<li><a class="reference internal" href="#session-links">Session Links</a></li>
<li><a class="reference internal" href="#session-files">Session Files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#file-upload">File Upload</a><ul>
<li><a class="reference internal" href="#upload-file-contents">Upload File Contents</a></li>
<li><a class="reference internal" href="#resume-an-upload">Resume an Upload</a></li>
<li><a class="reference internal" href="#canceling-an-in-progress-upload">Canceling an In-Progress Upload</a></li>
<li><a class="reference internal" href="#delete-a-partial-or-fully-uploaded-file">Delete a Partial or Fully Uploaded File</a></li>
<li><a class="reference internal" href="#replacing-a-partially-or-fully-uploaded-file">Replacing a Partially or Fully Uploaded File</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-status">Session Status</a></li>
<li><a class="reference internal" href="#session-extension">Session Extension</a></li>
<li><a class="reference internal" href="#session-cancellation">Session Cancellation</a></li>
<li><a class="reference internal" href="#session-completion">Session Completion</a></li>
<li><a class="reference internal" href="#session-token">Session Token</a></li>
<li><a class="reference internal" href="#stage-previews">Stage Previews</a></li>
</ul>
</li>
<li><a class="reference internal" href="#errors">Errors</a></li>
<li><a class="reference internal" href="#content-types">Content Types</a></li>
</ul>
</li>
<li><a class="reference internal" href="#faq">FAQ</a><ul>
<li><a class="reference internal" href="#does-this-mean-pypi-is-planning-to-drop-support-for-the-existing-upload-api">Does this mean PyPI is planning to drop support for the existing upload API?</a></li>
<li><a class="reference internal" href="#is-this-resumable-upload-protocol-based-on-anything">Is this Resumable Upload protocol based on anything?</a></li>
<li><a class="reference internal" href="#can-i-use-the-upload-2-0-api-to-reserve-a-project-name">Can I use the upload 2.0 API to reserve a project name?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#open-questions">Open Questions</a><ul>
<li><a class="reference internal" href="#multipart-uploads-vs-tus">Multipart Uploads vs tus</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>This PEP proposes a standard API for uploading files to a Python package index such as PyPI.  Along
with standardization, the upload API provides additional useful features such as support for:</p>
<ul class="simple">
<li>an upload session, which can be used to simultaneously publish all wheels in a package release;</li>
<li>“staging” a release, which can be used to test uploads before publicly publishing them, without the
need for <a class="reference external" href="https://test.pypi.org/">test.pypi.org</a>;</li>
<li>artifacts which can be overwritten and replaced, until a session is published;</li>
<li>asynchronous and “chunked”, resumable file uploads, for more efficient use of network bandwidth;</li>
<li>detailed status on the state of artifact uploads;</li>
<li>new project creation without requiring the uploading of an artifact.</li>
</ul>
<p>Once this new upload API is adopted, the existing legacy API can be deprecated, however this PEP
does not propose a deprecation schedule for the legacy API.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale" role="doc-backlink">Rationale</a></h2>
<p>There is currently no standardized API for uploading files to a Python package index such as
PyPI. Instead, everyone has been forced to reverse engineer the existing <a class="reference external" href="https://docs.pypi.org/api/upload/">“legacy”</a> API.</p>
<p>The legacy API, while functional, leaks implementation details of the original PyPI code base,
which has been faithfully replicated in the new code base and alternative implementations.</p>
<p>In addition, there are a number of major issues with the legacy API:</p>
<ul class="simple">
<li>It is fully synchronous, which forces requests to be held open both for the upload itself, and
while the index processes the uploaded file to determine success or failure.</li>
<li>It does not support any mechanism for resuming an upload. With the largest default file size on
PyPI being around 1GB in size, requiring the entire upload to complete successfully means
bandwidth is wasted when such uploads experience a network interruption while the request is in
progress.</li>
<li>The atomic unit of operation is a single file.  This is problematic when a release logically
includes an sdist and multiple binary wheels, leading to race conditions where consumers get
different versions of the package if they are unlucky enough to require a package before their
platform’s wheel has completely uploaded. If the release uploads its sdist first, this may also
manifest in some consumers seeing only the sdist, triggering a local build from source.</li>
<li>Status reporting is very limited.  There’s no support for reporting multiple errors, warnings,
deprecations, etc.  Status is limited to the HTTP status code and reason phrase, of which the
reason phrase has been deprecated since HTTP/2 (<span class="target" id="index-0"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc7540.html#section-8.1.2.4"><strong>RFC 7540</strong></a>).</li>
<li>Metadata for a release is submitted alongside the file. However, as this metadata is famously
unreliable, most installers instead choose to download the entire file and read the metadata from
there.</li>
<li>There is no mechanism for allowing an index to do any sort of sanity checks before bandwidth gets
expended on an upload.  Many cases of invalid metadata or incorrect permissions could be checked
prior to uploading files.</li>
<li>There is no support for “staging” a release prior to publishing it to the index.</li>
<li>Creation of new projects requires the uploading of at least one file, leading to “stub” uploads
to claim a project namespace.</li>
</ul>
<p>The new upload API proposed in this PEP solves all of these problems, providing for a much more
flexible, bandwidth friendly approach, with better error reporting, a better release testing
experience, and atomic and simultaneous publishing of all release artifacts.</p>
</section>
<section id="legacy-api">
<h2><a class="toc-backref" href="#legacy-api" role="doc-backlink">Legacy API</a></h2>
<p>The following is an overview of the legacy API.  For the detailed description, consult the
<a class="reference external" href="https://docs.pypi.org/api/upload/">PyPI user guide documentation</a>.</p>
<section id="endpoint">
<h3><a class="toc-backref" href="#endpoint" role="doc-backlink">Endpoint</a></h3>
<p>The existing upload API lives at a base URL.  For PyPI, that URL is currently
<code class="docutils literal notranslate"><span class="pre">https://upload.pypi.org/legacy/</span></code>.  Clients performing uploads specify the API they want to call
by adding an <code class="docutils literal notranslate"><span class="pre">:action</span></code> URL parameter with a value of <code class="docutils literal notranslate"><span class="pre">file_upload</span></code>. <a class="footnote-reference brackets" href="#fn-action" id="id1">[1]</a></p>
<p>The legacy API also has a <code class="docutils literal notranslate"><span class="pre">protocol_version</span></code> parameter, in theory allowing new versions of the API
to be defined.  In practice this has never happened, and the value is always <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p>
<p>Thus, the effective upload API on PyPI is:
<code class="docutils literal notranslate"><span class="pre">https://upload.pypi.org/legacy/?:action=file_upload&amp;protocol_version=1</span></code>.</p>
</section>
<section id="encoding">
<h3><a class="toc-backref" href="#encoding" role="doc-backlink">Encoding</a></h3>
<p>The data to be submitted is submitted as a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request with the content type of
<code class="docutils literal notranslate"><span class="pre">multipart/form-data</span></code>.  This reflects the legacy API’s historical nature, which was originally
designed not as an API, but rather as a web form on the initial PyPI implementation, with client code
written to programmatically submit that form.</p>
</section>
<section id="content">
<h3><a class="toc-backref" href="#content" role="doc-backlink">Content</a></h3>
<p>Roughly speaking, the metadata contained within the package is submitted as parts where the content
disposition is <code class="docutils literal notranslate"><span class="pre">form-data</span></code>, and the metadata key is the name of the field. The names of these
various pieces of metadata are not documented, and they sometimes, but not always match the names
used in the <code class="docutils literal notranslate"><span class="pre">METADATA</span></code> files for package artifacts. The case rarely matches, and the <code class="docutils literal notranslate"><span class="pre">form-data</span></code>
to <code class="docutils literal notranslate"><span class="pre">METADATA</span></code> conversion is inconsistent.</p>
<p>The upload artifact file itself is sent as a <code class="docutils literal notranslate"><span class="pre">application/octet-stream</span></code> part with the name of
<code class="docutils literal notranslate"><span class="pre">content</span></code>, and if there is a PGP signature attached, then it will be included as a
<code class="docutils literal notranslate"><span class="pre">application/octet-stream</span></code> part with the name of <code class="docutils literal notranslate"><span class="pre">gpg_signature</span></code>.</p>
</section>
<section id="authentication">
<h3><a class="toc-backref" href="#authentication" role="doc-backlink">Authentication</a></h3>
<p>Upload authentication is also not standardized. On PyPI, authentication is through <a class="reference external" href="https://pypi.org/help/">API tokens</a> or <a class="reference external" href="https://docs.pypi.org/trusted-publishers/">Trusted Publisher (OpenID Connect)</a>.  Other indexes may support different authentication
methods.</p>
</section>
</section>
<section id="upload-2-0-api-specification">
<span id="spec"></span><h2><a class="toc-backref" href="#upload-2-0-api-specification" role="doc-backlink">Upload 2.0 API Specification</a></h2>
<p>This PEP draws inspiration from the <a class="reference external" href="https://www.ietf.org/archive/id/draft-ietf-httpbis-resumable-upload-05.html">Resumable Uploads for HTTP</a> internet draft,
however there are significant differences.  This is largely due to the unique nature of Python
package releases (i.e. metadata, multiple related artifacts, etc.), and the support for an upload
session and release stages.  Where it makes sense to adopt details of the draft, this PEP does so.</p>
<p>This PEP traces the root cause of most of the issues with the existing API to be roughly two things:</p>
<ul class="simple">
<li>The metadata is submitted alongside the file, rather than being parsed from the
file itself. <a class="footnote-reference brackets" href="#fn-metadata" id="id2">[2]</a></li>
<li>It supports only a single request, using only form data, that either succeeds or fails, and all
actions are atomic within that single request.</li>
</ul>
<p>To address these issues, this PEP proposes a multi-request workflow, which at a high level involves
these steps:</p>
<ol class="arabic simple">
<li>Initiate an upload session, creating a release stage.</li>
<li>Upload the file(s) to that stage as part of the upload session.</li>
<li>Complete the upload session, publishing or discarding the stage.</li>
<li>Optionally check the status of an upload session.</li>
</ol>
<section id="versioning">
<h3><a class="toc-backref" href="#versioning" role="doc-backlink">Versioning</a></h3>
<p>This PEP uses the same <code class="docutils literal notranslate"><span class="pre">MAJOR.MINOR</span></code> versioning system as used in <a class="pep reference internal" href="../pep-0691/" title="PEP 691 – JSON-based Simple API for Python Package Indexes">PEP 691</a>, but it is otherwise
independently versioned. The legacy API is considered by this PEP to be version <code class="docutils literal notranslate"><span class="pre">1.0</span></code>, but this
PEP does not modify the legacy API in any way.</p>
<p>The API proposed in this PEP therefor has the version number <code class="docutils literal notranslate"><span class="pre">2.0</span></code>.</p>
</section>
<section id="root-endpoint">
<h3><a class="toc-backref" href="#root-endpoint" role="doc-backlink">Root Endpoint</a></h3>
<p>All URLs described here are relative to the “root endpoint”, which may be located anywhere within
the url structure of a domain. For example, the root endpoint could be
<code class="docutils literal notranslate"><span class="pre">https://upload.example.com/</span></code>, or <code class="docutils literal notranslate"><span class="pre">https://example.com/upload/</span></code>.</p>
<p>Specifically for PyPI, this PEP proposes to implement the root endpoint at
<code class="docutils literal notranslate"><span class="pre">https://upload.pypi.org/2.0</span></code>.  This root URL will be considered provisional while the feature is
being tested, and will be blessed as permanent after sufficient testing with live projects.</p>
<section id="create-an-upload-session">
<span id="session-create"></span><h4><a class="toc-backref" href="#create-an-upload-session" role="doc-backlink">Create an Upload Session</a></h4>
<p>A release starts by creating a new upload session.  To create the session, a client submits a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request
to the root URL, with a payload that looks like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;meta&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;api-version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;foo&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;nonce&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;string&gt;&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The request includes the following top-level keys:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">meta</span></code> (<strong>required</strong>)</dt><dd>Describes information about the payload itself.  Currently, the only defined sub-key is
<code class="docutils literal notranslate"><span class="pre">api-version</span></code> the value of which must be the string <code class="docutils literal notranslate"><span class="pre">&quot;2.0&quot;</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code> (<strong>required</strong>)</dt><dd>The name of the project that this session is attempting to release a new version of.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">version</span></code> (<strong>required</strong>)</dt><dd>The version of the project that this session is attempting to add files to.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">nonce</span></code> (<strong>optional</strong>)</dt><dd>An additional client-side string input to the <a class="reference internal" href="#session-token"><span class="std std-ref">“session token”</span></a>
algorithm.  Details are provided below, but if this key is omitted, it is equivalent
to passing the empty string.</dd>
</dl>
<p>Upon successful session creation, the server returns a <code class="docutils literal notranslate"><span class="pre">201</span> <span class="pre">Created</span></code> response.  If an error
occurs, the appropriate <code class="docutils literal notranslate"><span class="pre">4xx</span></code> code will be returned, as described in the <a class="reference internal" href="#session-errors"><span class="std std-ref">Errors</span></a>
section.</p>
<p>If a session is created for a project which has no previous release, then the index <strong>MAY</strong> reserve
the project name before the session is published, however it <strong>MUST NOT</strong> be possible to navigate to
that project using the “regular” (i.e. <a class="reference internal" href="#staged-preview"><span class="std std-ref">unstaged</span></a>) access protocols, <em>until</em>
the stage is published.  If this first-release stage gets canceled, then the index <strong>SHOULD</strong> delete
the project record, as if it were never uploaded.</p>
<p>The session is owned by the user that created it, and all subsequent requests <strong>MUST</strong> be performed
with the same credentials, otherwise a <code class="docutils literal notranslate"><span class="pre">403</span> <span class="pre">Forbidden</span></code> will be returned on those subsequent
requests.</p>
<section id="response-body">
<span id="session-response"></span><h5><a class="toc-backref" href="#response-body" role="doc-backlink">Response Body</a></h5>
<p>The successful response includes the following JSON content:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;meta&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;api-version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;links&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;upload&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;session&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;session-token&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&lt;token-string&gt;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;valid-for&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">604800</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="nt">&quot;notices&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;a notice to display to the user&quot;</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Besides the <code class="docutils literal notranslate"><span class="pre">meta</span></code> key, which has the same format as the request JSON, the success response has
the following keys:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">links</span></code></dt><dd>A dictionary mapping <a class="reference internal" href="#session-links"><span class="std std-ref">keys to URLs</span></a> related to this session, the details of
which are provided below.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">session-token</span></code></dt><dd>If the index supports <a class="reference internal" href="#staged-preview"><span class="std std-ref">previewing staged releases</span></a>, this key will contain
the unique <a class="reference internal" href="#session-token"><span class="std std-ref">“session token”</span></a> that can be provided to installers in order to
preview the staged release before it’s published.  If the index does <em>not</em> support stage
previewing, this key <strong>MUST</strong> be omitted.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">valid-for</span></code></dt><dd>An integer representing how long, in seconds, until the server itself will expire this session,
and thus all of its content, including any uploaded files and the URL links related to the
session. This value is roughly relative to the time at which the session was created or
<a class="reference internal" href="#session-extension"><span class="std std-ref">extended</span></a>.  The session <strong>SHOULD</strong> live at least this much longer
unless the client itself has canceled or published the session. Servers <strong>MAY</strong> choose to
<em>increase</em> this time, but should never <em>decrease</em> it, except naturally through the passage of
time.  Clients can query the <a class="reference internal" href="#session-status"><span class="std std-ref">session status</span></a> to get time remaining in the
session.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">status</span></code></dt><dd>A string that contains one of <code class="docutils literal notranslate"><span class="pre">pending</span></code>, <code class="docutils literal notranslate"><span class="pre">published</span></code>, <code class="docutils literal notranslate"><span class="pre">error</span></code>, or <code class="docutils literal notranslate"><span class="pre">canceled</span></code>,
representing the overall <a class="reference internal" href="#session-status"><span class="std std-ref">status of the session</span></a>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">files</span></code></dt><dd>A mapping containing the filenames that have been uploaded to this session, to a mapping
containing details about each <a class="reference internal" href="#session-files"><span class="std std-ref">file referenced in this session</span></a>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">notices</span></code></dt><dd>An optional key that points to an array of human-readable informational notices that the server
wishes to communicate to the end user.  These notices are specific to the overall session, not
to any particular file in the session.</dd>
</dl>
</section>
<section id="session-links">
<span id="id3"></span><h5><a class="toc-backref" href="#session-links" role="doc-backlink">Session Links</a></h5>
<p>For the <code class="docutils literal notranslate"><span class="pre">links</span></code> key in the success JSON, the following sub-keys are valid:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">upload</span></code></dt><dd>The endpoint session clients will use to initiate <a class="reference internal" href="#file-uploads"><span class="std std-ref">uploads</span></a> for each file to
be included in this session.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">stage</span></code></dt><dd>The endpoint where this staged release can be <a class="reference internal" href="#staged-preview"><span class="std std-ref">previewed</span></a> prior to
publishing the session.  This can be used to download and verify the not-yet-public files.  If
the index does not support previewing staged releases, this key <strong>MUST</strong> be omitted.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">session</span></code></dt><dd>The endpoint where actions for this session can be performed, including <a class="reference internal" href="#publish-session"><span class="std std-ref">publishing this
session</span></a>, <a class="reference internal" href="#session-cancellation"><span class="std std-ref">canceling and discarding the session</span></a>,
<a class="reference internal" href="#session-status"><span class="std std-ref">querying the current session status</span></a>, and <a class="reference internal" href="#session-extension"><span class="std std-ref">requesting an extension
of the session lifetime</span></a> (<em>if</em> the server supports it).</dd>
</dl>
</section>
<section id="session-files">
<span id="id4"></span><h5><a class="toc-backref" href="#session-files" role="doc-backlink">Session Files</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">files</span></code> key contains a mapping from the names of the files uploaded in this session to a
sub-mapping with the following keys:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">status</span></code></dt><dd>A string with the same values and semantics as the <a class="reference internal" href="#session-status"><span class="std std-ref">session status key</span></a>,
except that it indicates the status of the specific referenced file.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">link</span></code></dt><dd>The <em>absolute</em> URL that the client should use to reference this specific file.  This URL is used
to retrieve, replace, or delete the <a class="reference internal" href="#file-uploads"><span class="std std-ref">referenced file</span></a>.  If a <code class="docutils literal notranslate"><span class="pre">nonce</span></code> was
provided, this URL <strong>MUST</strong> be obfuscated with a non-guessable token as described in the
<a class="reference internal" href="#session-token"><span class="std std-ref">session token</span></a> section.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">notices</span></code></dt><dd>An optional key with similar format and semantics as the <code class="docutils literal notranslate"><span class="pre">notices</span></code> session key, except that
these notices are specific to the referenced file.</dd>
</dl>
<p>If a second session is created for the same name-version pair while a session for that pair is in
the <code class="docutils literal notranslate"><span class="pre">pending</span></code> state, then the server <strong>MUST</strong> return the JSON status response for the already
existing session, along with the <code class="docutils literal notranslate"><span class="pre">200</span> <span class="pre">Ok</span></code> status code rather than creating a new, empty session.</p>
</section>
</section>
<section id="file-upload">
<span id="file-uploads"></span><h4><a class="toc-backref" href="#file-upload" role="doc-backlink">File Upload</a></h4>
<p>After creating the session, the <code class="docutils literal notranslate"><span class="pre">upload</span></code> endpoint from the response’s <a class="reference internal" href="#session-links"><span class="std std-ref">session links</span></a> mapping is used to begin the upload of new files into that session.  Clients
<strong>MUST</strong> use the provided <code class="docutils literal notranslate"><span class="pre">upload</span></code> URL and <strong>MUST NOT</strong> assume there is any pattern or commonality
to those URLs from one session to the next.</p>
<p>To initiate a file upload, a client first sends a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request to the <code class="docutils literal notranslate"><span class="pre">upload</span></code> URL.  The
request body has the following JSON format:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;meta&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;api-version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;filename&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;foo-1.0.tar.gz&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;hashes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;sha256&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;blake2b&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Besides the standard <code class="docutils literal notranslate"><span class="pre">meta</span></code> key, the request JSON has the following additional keys:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">filename</span></code> (<strong>required</strong>)</dt><dd>The name of the file being uploaded.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size</span></code> (<strong>required</strong>)</dt><dd>The size in bytes of the file being uploaded.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hashes</span></code> (<strong>required</strong>)</dt><dd>A mapping of hash names to hex-encoded digests.  Each of these digests are the checksums of the
file being uploaded when hashed by the algorithm identified in the name.<p>By default, any hash algorithm available in <a class="reference external" href="https://docs.python.org/3/library/hashlib.html">hashlib</a> can be used as a key for the hashes
dictionary <a class="footnote-reference brackets" href="#fn-hash" id="id5">[3]</a>. At least one secure algorithm from <code class="docutils literal notranslate"><span class="pre">hashlib.algorithms_guaranteed</span></code>
<strong>MUST</strong> always be included. This PEP specifically recommends <code class="docutils literal notranslate"><span class="pre">sha256</span></code>.</p>
<p>Multiple hashes may be passed at a time, but all hashes provided <strong>MUST</strong> be valid for the file.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">metadata</span></code> (<strong>optional</strong>)</dt><dd>If given, this is a string value containing the file’s <a class="reference external" href="https://packaging.python.org/en/latest/specifications/core-metadata/">core metadata</a>.</dd>
</dl>
<p>Servers <strong>MAY</strong> use the data provided in this request to do some sanity checking prior to allowing
the file to be uploaded.  These checks may include, but are not limited to:</p>
<ul class="simple">
<li>checking if the <code class="docutils literal notranslate"><span class="pre">filename</span></code> already exists in a published release;</li>
<li>checking if the <code class="docutils literal notranslate"><span class="pre">size</span></code> would exceed any project or file quota;</li>
<li>checking if the contents of the <code class="docutils literal notranslate"><span class="pre">metadata</span></code>, if provided, are valid.</li>
</ul>
<p>If the server determines that upload should proceed, it will return a <code class="docutils literal notranslate"><span class="pre">201</span> <span class="pre">Created</span></code> response, with
an empty body, and a <code class="docutils literal notranslate"><span class="pre">Location</span></code> header pointing to the URL that the file content should be
uploaded to.  The <a class="reference internal" href="#session-status"><span class="std std-ref">status</span></a> of the session will also include the filename in
the <code class="docutils literal notranslate"><span class="pre">files</span></code> mapping, with the above <code class="docutils literal notranslate"><span class="pre">Location</span></code> URL included in under the <code class="docutils literal notranslate"><span class="pre">link</span></code> sub-key.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <a class="reference external" href="https://www.ietf.org/archive/id/draft-ietf-httpbis-resumable-upload-05.html">IETF draft</a> calls this the URL of the <a class="reference external" href="https://www.ietf.org/archive/id/draft-ietf-httpbis-resumable-upload-05.html#name-upload-creation-2">upload resource</a>, and this PEP uses that nomenclature as well.</p>
</div>
<section id="upload-file-contents">
<span id="upload-contents"></span><h5><a class="toc-backref" href="#upload-file-contents" role="doc-backlink">Upload File Contents</a></h5>
<p>The actual file contents are uploaded by issuing a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request to the upload resource URL
<a class="footnote-reference brackets" href="#fn-location" id="id6">[5]</a>.  The client may either upload the entire file in a single request, or it may opt
for “chunked” upload where the file contents are split into multiple requests, as described below.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The protocol defined in this PEP differs from the <a class="reference external" href="https://www.ietf.org/archive/id/draft-ietf-httpbis-resumable-upload-05.html">IETF draft</a> in a few ways:</p>
<ul class="simple">
<li>For chunked uploads, the <a class="reference external" href="https://www.ietf.org/archive/id/draft-ietf-httpbis-resumable-upload-05.html#name-upload-append-2">second and subsequent chunks</a> are uploaded
using a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request instead of <code class="docutils literal notranslate"><span class="pre">PATCH</span></code> requests.  Similarly, this PEP uses
<code class="docutils literal notranslate"><span class="pre">application/octet-stream</span></code> for the <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> headers for all chunks.</li>
<li>No <code class="docutils literal notranslate"><span class="pre">Upload-Draft-Interop-Version</span></code> header is required.</li>
<li>Some of the server responses are different.</li>
</ul>
</div>
<p>When uploading the entire file in a single request, the request <strong>MUST</strong> include the following
headers (e.g. for a 100,000 byte file):</p>
<div class="highlight-email notranslate"><div class="highlight"><pre><span></span><span class="nt">Content-Length:</span><span class="w"> </span>100000
<span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">application</span><span class="dl">/</span><span class="nl">octet-stream</span>
<span class="nt">Upload-Length:</span><span class="w"> </span>100000
<span class="nt">Upload-Complete:</span><span class="w"> </span>?1
</pre></div>
</div>
<p>The body of this request contains all 100,000 bytes of the unencoded raw binary data.</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">Content-Length</span></code></dt><dd>The number of file bytes contained in the body of <em>this</em> request.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Content-Type</span></code></dt><dd><strong>MUST</strong> be <code class="docutils literal notranslate"><span class="pre">application/octet-stream</span></code>.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Upload-Length</span></code></dt><dd>Indicates the total number of bytes that will be uploaded for this file.  For single-request
uploads this will always be equal to <code class="docutils literal notranslate"><span class="pre">Content-Length</span></code>, but these values will likely differ for
chunked uploads.  This value <strong>MUST</strong> equal the number of bytes given in the <code class="docutils literal notranslate"><span class="pre">size</span></code> field of
the file upload initiation request.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Upload-Complete</span></code></dt><dd>A flag indicating whether more chunks are coming for this file.  For single-request uploads, the
value of this header <strong>MUST</strong> be <code class="docutils literal notranslate"><span class="pre">?1</span></code>.</dd>
</dl>
<p>If the upload completes successfully, the server <strong>MUST</strong> respond with a <code class="docutils literal notranslate"><span class="pre">201</span> <span class="pre">Created</span></code> status.
The response body has no content.</p>
<p>If this single-request upload fails, the entire file must be resent in another single HTTP request.
This is the recommended, preferred format for file uploads since fewer requests are required.</p>
<p>As an example, if the client was to upload a 100,000 byte file, the headers would look like:</p>
<div class="highlight-email notranslate"><div class="highlight"><pre><span></span><span class="nt">Content-Length:</span><span class="w"> </span>100000
<span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">application</span><span class="dl">/</span><span class="nl">octet-stream</span>
<span class="nt">Upload-Length:</span><span class="w"> </span>100000
<span class="nt">Upload-Complete:</span><span class="w"> </span>?1
</pre></div>
</div>
<p>Clients can opt to upload the file in multiple chunks.  Because the upload resource URL provided in
the metadata response will be unique per file, clients <strong>MUST</strong> use the given upload resource URL
for all chunks.  Clients upload file chunks by sending multiple <code class="docutils literal notranslate"><span class="pre">POST</span></code> requests to this URL, with
one request per chunk.</p>
<p>For chunked uploads, the <code class="docutils literal notranslate"><span class="pre">Content-Length</span></code> is equal to the size in bytes of the chunk that is
currently being sent. The client <strong>MUST</strong> include a <code class="docutils literal notranslate"><span class="pre">Upload-Offset</span></code> header which indicates the
byte offset that the content included in this chunk’s request starts at, and an <code class="docutils literal notranslate"><span class="pre">Upload-Complete</span></code>
header with the value <code class="docutils literal notranslate"><span class="pre">?0</span></code>.  For the first chunk, the <code class="docutils literal notranslate"><span class="pre">Upload-Offset</span></code> header <strong>MUST</strong> be set to
<code class="docutils literal notranslate"><span class="pre">0</span></code>.  As with single-request uploads, the <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> header is <code class="docutils literal notranslate"><span class="pre">application/octet-stream</span></code>
and the body is the raw, unencoded bytes of the chunk.</p>
<p>For example, if uploading a 100,000 byte file in 1000 byte chunks, the first chunk’s request headers
would be:</p>
<div class="highlight-email notranslate"><div class="highlight"><pre><span></span><span class="nt">Content-Length:</span><span class="w"> </span>1000
<span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">application</span><span class="dl">/</span><span class="nl">octet-stream</span>
<span class="nt">Upload-Offset:</span><span class="w"> </span>0
<span class="nt">Upload-Length:</span><span class="w"> </span>100000
<span class="nt">Upload-Complete:</span><span class="w"> </span>?0
</pre></div>
</div>
<p>For the second chunk representing bytes 1000 through 1999, include the following headers:</p>
<div class="highlight-email notranslate"><div class="highlight"><pre><span></span><span class="nt">Content-Length:</span><span class="w"> </span>1000
<span class="nt">Content-Type:</span><span class="w"> </span><span class="nl">application</span><span class="dl">/</span><span class="nl">octet-stream</span>
<span class="nt">Upload-Offset:</span><span class="w"> </span>1000
<span class="nt">Upload-Length:</span><span class="w"> </span>100000
<span class="nt">Upload-Complete:</span><span class="w"> </span>?0
</pre></div>
</div>
<p>These requests would continue sequentially until the last chunk is ready to be uploaded.</p>
<p>For each successful chunk, the server <strong>MUST</strong> respond with a <code class="docutils literal notranslate"><span class="pre">202</span> <span class="pre">Accepted</span></code> header, except for
the final chunk, which <strong>MUST</strong> be a <code class="docutils literal notranslate"><span class="pre">201</span> <span class="pre">Created</span></code>, and as with non-chunked uploads, the body of
these responses has no content.</p>
<p id="complete-the-upload">The final chunk of data <strong>MUST</strong> include the <code class="docutils literal notranslate"><span class="pre">Upload-Complete:</span> <span class="pre">?1</span></code> header, since at that point the
entire file has been uploaded.</p>
<p>With both chunked and non-chunked uploads, once completed successfully, the file <strong>MUST</strong> not be
publicly visible in the repository, but merely staged until the upload session is <a class="reference internal" href="#publish-session"><span class="std std-ref">completed</span></a>. If the server supports <a class="reference internal" href="#staged-preview"><span class="std std-ref">previews</span></a>, the file <strong>MUST</strong> be
visible at the <code class="docutils literal notranslate"><span class="pre">stage</span></code> <a class="reference internal" href="#session-links"><span class="std std-ref">URL</span></a>.  Partially uploaded chunked files <strong>SHOULD
NOT</strong> be visible at the <code class="docutils literal notranslate"><span class="pre">stage</span></code> URL.</p>
<p>The following constraints are placed on uploads regardless of whether they are single chunk or
multiple chunks:</p>
<ul class="simple">
<li>A client <strong>MUST NOT</strong> perform multiple <code class="docutils literal notranslate"><span class="pre">POST</span></code> requests in parallel for the same file to avoid
race conditions and data loss or corruption.</li>
<li>If the offset provided in <code class="docutils literal notranslate"><span class="pre">Upload-Offset</span></code> is not <code class="docutils literal notranslate"><span class="pre">0</span></code> or correctly specifies the byte offset of
the next chunk in an incomplete upload, then the server <strong>MUST</strong> respond with a <code class="docutils literal notranslate"><span class="pre">409</span> <span class="pre">Conflict</span></code>.
This means that a client <strong>MAY NOT</strong> upload chunks out of order.</li>
<li>Once a file upload has completed successfully, you may initiate another upload for that file,
which <strong>once completed</strong>, will replace that file.  This is possible until the entire session is
completed, at which point no further file uploads (either creating or replacing a session file)
are accepted.  I.e. once a session is published, the files included in that release are immutable
<a class="footnote-reference brackets" href="#fn-immutable" id="id7">[4]</a>.</li>
</ul>
</section>
<section id="resume-an-upload">
<h5><a class="toc-backref" href="#resume-an-upload" role="doc-backlink">Resume an Upload</a></h5>
<p>To resume an upload, you first have to know how much of the file’s contents the server has already
received.  If this is not already known, a client can make a <code class="docutils literal notranslate"><span class="pre">HEAD</span></code> request to the upload resource
URL.</p>
<p>The server <strong>MUST</strong> respond with a <code class="docutils literal notranslate"><span class="pre">204</span> <span class="pre">No</span> <span class="pre">Content</span></code> response, with an <code class="docutils literal notranslate"><span class="pre">Upload-Offset</span></code> header
that indicates what offset the client should continue uploading from. If the server has not received
any data, then this would be <code class="docutils literal notranslate"><span class="pre">0</span></code>, if it has received 1007 bytes then it would be <code class="docutils literal notranslate"><span class="pre">1007</span></code>.  For
this example, the full response headers would look like:</p>
<div class="highlight-email notranslate"><div class="highlight"><pre><span></span><span class="nt">Upload-Offset:</span><span class="w"> </span>1007
<span class="nt">Upload-Complete:</span><span class="w"> </span>?0
<span class="nt">Cache-Control:</span><span class="w"> </span>no-store
</pre></div>
</div>
<p>Once the client has retrieved the offset that they need to start from, they can upload the rest of
the file as described above, either in a single request containing all of the remaining bytes, or in
multiple chunks as per the above protocol.</p>
</section>
<section id="canceling-an-in-progress-upload">
<span id="cancel-an-upload"></span><h5><a class="toc-backref" href="#canceling-an-in-progress-upload" role="doc-backlink">Canceling an In-Progress Upload</a></h5>
<p>If a client wishes to cancel an upload of a specific file, for instance because they need to upload
a different file, they may do so by issuing a <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> request to the upload resource URL of the
file they want to delete.</p>
<p>A successful cancellation request <strong>MUST</strong> respond with a <code class="docutils literal notranslate"><span class="pre">204</span> <span class="pre">No</span> <span class="pre">Content</span></code>.</p>
<p>Once deleting, a client <strong>MUST NOT</strong> assume that the previous upload resource URL can be reused.</p>
</section>
<section id="delete-a-partial-or-fully-uploaded-file">
<h5><a class="toc-backref" href="#delete-a-partial-or-fully-uploaded-file" role="doc-backlink">Delete a Partial or Fully Uploaded File</a></h5>
<p>Similarly, for files which have already been completely uploaded, clients can delete the file by
issuing a <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> request to the upload resource  URL.</p>
<p>A successful deletion request <strong>MUST</strong> response with a <code class="docutils literal notranslate"><span class="pre">204</span> <span class="pre">No</span> <span class="pre">Content</span></code>.</p>
<p>Once deleting, a client <strong>MUST NOT</strong> assume that the previous upload resource URL can be reused.</p>
</section>
<section id="replacing-a-partially-or-fully-uploaded-file">
<h5><a class="toc-backref" href="#replacing-a-partially-or-fully-uploaded-file" role="doc-backlink">Replacing a Partially or Fully Uploaded File</a></h5>
<p>To replace a session file, the file upload <strong>MUST</strong> have been previously completed or deleted.  It
is not possible to replace a file if the upload for that file is incomplete.  Clients have two
options to replace an incomplete upload:</p>
<ul class="simple">
<li><a class="reference internal" href="#cancel-an-upload"><span class="std std-ref">Cancel the in-progress upload</span></a> by issuing a <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> to the upload
resource URL for the file they want to replace.  After this, the new file upload can be initiated
by beginning the entire <a class="reference internal" href="#file-uploads"><span class="std std-ref">file upload</span></a> sequence over again.  This means
providing the metadata request again to retrieve a new upload resource URL.  Client <strong>MUST NOT</strong>
assume that the previous upload resource URL can be reused after deletion.</li>
<li><a class="reference internal" href="#complete-the-upload"><span class="std std-ref">Complete the in-progress upload</span></a> by uploading a zero-length chunk
providing the <code class="docutils literal notranslate"><span class="pre">Upload-Complete:</span> <span class="pre">?1</span></code> header.  This effectively truncates and completes the
in-progress upload, after which point the new upload can commence.  In this case, clients
<strong>SHOULD</strong> reuse the previous upload resource URL and do not need to begin the entire <a class="reference internal" href="#file-uploads"><span class="std std-ref">file
upload</span></a> sequence over again.</li>
</ul>
</section>
</section>
<section id="session-status">
<span id="id8"></span><h4><a class="toc-backref" href="#session-status" role="doc-backlink">Session Status</a></h4>
<p>At any time, a client can query the status of the session by issuing a <code class="docutils literal notranslate"><span class="pre">GET</span></code> request to the
<code class="docutils literal notranslate"><span class="pre">session</span></code> <a class="reference internal" href="#session-links"><span class="std std-ref">link</span></a> given in the <a class="reference internal" href="#session-response"><span class="std std-ref">session creation response body</span></a>.</p>
<p>The server will respond to this <code class="docutils literal notranslate"><span class="pre">GET</span></code> request with the same <a class="reference internal" href="#session-response"><span class="std std-ref">response</span></a>
that they got when they initially created the upload session, except with any changes to <code class="docutils literal notranslate"><span class="pre">status</span></code>,
<code class="docutils literal notranslate"><span class="pre">valid-for</span></code>, or <code class="docutils literal notranslate"><span class="pre">files</span></code> reflected.</p>
</section>
<section id="session-extension">
<span id="id9"></span><h4><a class="toc-backref" href="#session-extension" role="doc-backlink">Session Extension</a></h4>
<p>Servers <strong>MAY</strong> allow clients to extend sessions, but the overall lifetime and number of extensions
allowed is left to the server.  To extend a session, a client issues a <code class="docutils literal notranslate"><span class="pre">POST</span></code> request to the
<code class="docutils literal notranslate"><span class="pre">session</span></code> <a class="reference internal" href="#session-links"><span class="std std-ref">link</span></a> given in the <a class="reference internal" href="#session-response"><span class="std std-ref">session creation response body</span></a>.</p>
<p>The JSON body of this request looks like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;meta&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;api-version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;:action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;extend&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;extend-for&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3600</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The number of seconds specified is just a suggestion to the server for the number of additional
seconds to extend the current session.  For example, if the client wants to extend the current
session for another hour, <code class="docutils literal notranslate"><span class="pre">extend-for</span></code> would be <code class="docutils literal notranslate"><span class="pre">3600</span></code>.  Upon successful extension, the server
will respond with the same <a class="reference internal" href="#session-response"><span class="std std-ref">response</span></a> that they got when they initially
created the upload session, except with any changes to <code class="docutils literal notranslate"><span class="pre">status</span></code>, <code class="docutils literal notranslate"><span class="pre">valid-for</span></code>, or <code class="docutils literal notranslate"><span class="pre">files</span></code>
reflected.</p>
<p>If the server refuses to extend the session for the requested number of seconds, it still returns a
success response, and the <code class="docutils literal notranslate"><span class="pre">valid-for</span></code> key will simply include the number of seconds remaining in
the current session.</p>
</section>
<section id="session-cancellation">
<span id="id10"></span><h4><a class="toc-backref" href="#session-cancellation" role="doc-backlink">Session Cancellation</a></h4>
<p>To cancel an entire session, a client issues a <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> request to the <code class="docutils literal notranslate"><span class="pre">session</span></code> <a class="reference internal" href="#session-links"><span class="std std-ref">link</span></a> given in the <a class="reference internal" href="#session-response"><span class="std std-ref">session creation response body</span></a>.  The server
then marks the session as canceled, and <strong>SHOULD</strong> purge any data that was uploaded as part of that
session.  Future attempts to access that session URL or any of the upload session URLs <strong>MUST</strong>
return a <code class="docutils literal notranslate"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></code>.</p>
<p>To prevent dangling sessions, servers may also choose to cancel timed-out sessions on their own
accord. It is recommended that servers expunge their sessions after no less than a week, but each
server may choose their own schedule.  Servers <strong>MAY</strong> support client-directed <a class="reference internal" href="#session-extension"><span class="std std-ref">session
extensions</span></a>.</p>
</section>
<section id="session-completion">
<span id="publish-session"></span><h4><a class="toc-backref" href="#session-completion" role="doc-backlink">Session Completion</a></h4>
<p>To complete a session and publish the files that have been included in it, a client issues a
<code class="docutils literal notranslate"><span class="pre">POST</span></code> request to the <code class="docutils literal notranslate"><span class="pre">session</span></code> <a class="reference internal" href="#session-links"><span class="std std-ref">link</span></a> given in the <a class="reference internal" href="#session-response"><span class="std std-ref">session creation
response body</span></a>.</p>
<p>The JSON body of this request looks like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;meta&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;api-version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;:action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;publish&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the server is able to immediately complete the session, it may do so and return a <code class="docutils literal notranslate"><span class="pre">201</span> <span class="pre">Created</span></code>
response. If it is unable to immediately complete the session (for instance, if it needs to do
processing that may take longer than reasonable in a single HTTP request), then it may return a
<code class="docutils literal notranslate"><span class="pre">202</span> <span class="pre">Accepted</span></code> response.</p>
<p>In either case, the server should include a <code class="docutils literal notranslate"><span class="pre">Location</span></code> header pointing back to the session status
URL, and if the server returned a <code class="docutils literal notranslate"><span class="pre">202</span> <span class="pre">Accepted</span></code>, the client may poll that URL to watch for the
status to change.</p>
<p>If a session is published that has no staged files, the operation is effectively a no-op, except
where a new project name is being reserved.  In this case, the new project is created, reserved, and
owned by the user that created the session.</p>
</section>
<section id="session-token">
<span id="id11"></span><h4><a class="toc-backref" href="#session-token" role="doc-backlink">Session Token</a></h4>
<p>When creating a session, clients can provide a <code class="docutils literal notranslate"><span class="pre">nonce</span></code> in the <a class="reference internal" href="#session-create"><span class="std std-ref">initial session creation
request</span></a> .  This nonce is a string with arbitrary content.  The <code class="docutils literal notranslate"><span class="pre">nonce</span></code> is
optional, and if omitted, is equivalent to providing an empty string.</p>
<p>In order to support previewing of staged uploads, the package <code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">version</span></code>, along with
this <code class="docutils literal notranslate"><span class="pre">nonce</span></code> are used as input into a hashing algorithm to produce a unique “session token”.  This
session token is valid for the life of the session (i.e., until it is completed, either by
cancellation or publishing), and can be provided to supporting installers to gain access to the
staged release.</p>
<p>The use of the <code class="docutils literal notranslate"><span class="pre">nonce</span></code> allows clients to decide whether they want to obscure the visibility of
their staged releases or not, and there can be good reasons for either choice.  For example, if a CI
system wants to upload some wheels for a new release, and wants to allow independent validation of a
stage before it’s published, the client may opt for not including a nonce.  On the other hand, if a
client would like to pre-seed a release which it publishes atomically at the time of a public
announcement, that client will likely opt for providing a nonce.</p>
<p>The <a class="reference external" href="https://docs.python.org/3/library/hashlib.html#hashlib.sha256">SHA256 algorithm</a> is used to
turn these inputs into a unique token, in the order <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">version</span></code>, <code class="docutils literal notranslate"><span class="pre">nonce</span></code>, using the
following Python code as an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">hashlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">sha256</span>

<span class="k">def</span><span class="w"> </span><span class="nf">gentoken</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">nonce</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">()</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
</div>
<p>It should be evident that if no <code class="docutils literal notranslate"><span class="pre">nonce</span></code> is provided in the <a class="reference internal" href="#session-create"><span class="std std-ref">session creation request</span></a>, then the preview token is easily guessable from the package name and version
number alone.  Clients can elect to omit the <code class="docutils literal notranslate"><span class="pre">nonce</span></code> (or set it to the empty string themselves) if
they want to allow previewing from anybody without access to the preview token.  By providing a
non-empty <code class="docutils literal notranslate"><span class="pre">nonce</span></code>, clients can elect for security-through-obscurity, but this does not protect
staged files behind any kind of authentication.</p>
</section>
<section id="stage-previews">
<span id="staged-preview"></span><h4><a class="toc-backref" href="#stage-previews" role="doc-backlink">Stage Previews</a></h4>
<p>The ability to preview staged releases before they are published is an important feature of this
PEP, enabling an additional level of last-mile testing before the release is available to the
public.  Indexes <strong>MAY</strong> provide this functionality through the URL provided in the <code class="docutils literal notranslate"><span class="pre">stage</span></code>
sub-key of the <a class="reference internal" href="#session-links"><span class="std std-ref">links key</span></a> returned when the session is created.  The <code class="docutils literal notranslate"><span class="pre">stage</span></code>
URL can be passed to installers such as <code class="docutils literal notranslate"><span class="pre">pip</span></code> by setting the <a class="reference external" href="https://pip.pypa.io/en/stable/cli/pip_install/#cmdoption-extra-index-url">–extra-index-url</a> flag to this value.
Multiple stages can even be previewed by repeating this flag with multiple values.</p>
<p>In the future, it may be valuable to include something like a <code class="docutils literal notranslate"><span class="pre">Stage-Token</span></code> header to the <a class="reference external" href="https://packaging.python.org/en/latest/specifications/simple-repository-api/">Simple
Repository API</a>
requests or the <a class="pep reference internal" href="../pep-0691/" title="PEP 691 – JSON-based Simple API for Python Package Indexes">PEP 691</a> JSON-based Simple API, with the value from the <code class="docutils literal notranslate"><span class="pre">session-token</span></code> sub-key
of the JSON response to the session creation request.  Multiple <code class="docutils literal notranslate"><span class="pre">Stage-Token</span></code> headers could be
allowed, and installers could support enabling stage previews by adding a <code class="docutils literal notranslate"><span class="pre">--staged</span> <span class="pre">&lt;token&gt;</span></code> or
similarly named option to set the <code class="docutils literal notranslate"><span class="pre">Stage-Token</span></code> header at the command line.  This feature is not
currently support, nor proposed by this PEP, though it could be proposed by a separate PEP in the
future.</p>
<p>In either case, the index will return views that expose the staged releases to the installer tool,
making them available to download and install into virtual environments built for that last-mile
testing.  The former option allows for existing installers to preview staged releases with no
changes, although perhaps in a less user-friendly way.  The latter option can be a better user
experience, but the details of this are left to installer tool maintainers.</p>
</section>
</section>
<section id="errors">
<span id="session-errors"></span><h3><a class="toc-backref" href="#errors" role="doc-backlink">Errors</a></h3>
<p>All error responses that contain content will have a body that looks like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;meta&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;api-version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;errors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Besides the standard <code class="docutils literal notranslate"><span class="pre">meta</span></code> key, this has the following top level keys:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">message</span></code></dt><dd>A singular message that encapsulates all errors that may have happened on this
request.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">errors</span></code></dt><dd>An array of specific errors, each of which contains a <code class="docutils literal notranslate"><span class="pre">source</span></code> key, which is a string that
indicates what the source of the error is, and a <code class="docutils literal notranslate"><span class="pre">message</span></code> key for that specific error.</dd>
</dl>
<p>The <code class="docutils literal notranslate"><span class="pre">message</span></code> and <code class="docutils literal notranslate"><span class="pre">source</span></code> strings do not have any specific meaning, and are intended for human
interpretation to aid in diagnosing underlying issue.</p>
</section>
<section id="content-types">
<h3><a class="toc-backref" href="#content-types" role="doc-backlink">Content Types</a></h3>
<p>Like <a class="pep reference internal" href="../pep-0691/" title="PEP 691 – JSON-based Simple API for Python Package Indexes">PEP 691</a>, this PEP proposes that all requests and responses from this upload API will have a
standard content type that describes what the content is, what version of the API it represents, and
what serialization format has been used.</p>
<p>This standard request content type applies to all requests <em>except</em> for <a class="reference internal" href="#upload-contents"><span class="std std-ref">file upload requests</span></a> which, since they contain only binary data, is always <code class="docutils literal notranslate"><span class="pre">application/octet-stream</span></code>.</p>
<p>The structure of the <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> header for all other requests is:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>application/vnd.pypi.upload.$version+$format
</pre></div>
</div>
<p>Since minor API version differences should never be disruptive, only the major version is included
in the content type; the version number is prefixed with a <code class="docutils literal notranslate"><span class="pre">v</span></code>.</p>
<p>Unlike <a class="pep reference internal" href="../pep-0691/" title="PEP 691 – JSON-based Simple API for Python Package Indexes">PEP 691</a>, this PEP does not change the existing <em>legacy</em> <code class="docutils literal notranslate"><span class="pre">1.0</span></code> upload API in any way, so
servers are required to host the new API described in this PEP at a different endpoint than the
existing upload API.</p>
<p>Since JSON is the only defined request format defined in this PEP, all non-file-upload requests
defined in this PEP <strong>MUST</strong> include a <code class="docutils literal notranslate"><span class="pre">Content-Type</span></code> header value of:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">application/vnd.pypi.upload.v2+json</span></code>.</li>
</ul>
<p>As with <a class="pep reference internal" href="../pep-0691/" title="PEP 691 – JSON-based Simple API for Python Package Indexes">PEP 691</a>, a special “meta” version is supported named <code class="docutils literal notranslate"><span class="pre">latest</span></code>, the purpose of which is
to allow clients to request the latest version implemented by the server, without having to know
ahead of time what that version is.  It is recommended however, that clients be explicit about what
versions they support.</p>
<p>Similar to <a class="pep reference internal" href="../pep-0691/" title="PEP 691 – JSON-based Simple API for Python Package Indexes">PEP 691</a>, this PEP also standardizes on using server-driven content negotiation to
allow clients to request different versions or serialization formats, which includes the <code class="docutils literal notranslate"><span class="pre">format</span></code>
part of the content type.  However, since this PEP expects the existing legacy <code class="docutils literal notranslate"><span class="pre">1.0</span></code> upload API to
exist at a different endpoint, and this PEP currently only provides for JSON serialization, this
mechanism is not particularly useful.  Clients only have a single version and serialization they can
request. However clients <strong>SHOULD</strong> be prepared to handle content negotiation gracefully in the case
that additional formats or versions are added in the future.</p>
</section>
</section>
<section id="faq">
<h2><a class="toc-backref" href="#faq" role="doc-backlink">FAQ</a></h2>
<section id="does-this-mean-pypi-is-planning-to-drop-support-for-the-existing-upload-api">
<h3><a class="toc-backref" href="#does-this-mean-pypi-is-planning-to-drop-support-for-the-existing-upload-api" role="doc-backlink">Does this mean PyPI is planning to drop support for the existing upload API?</a></h3>
<p>At this time PyPI does not have any specific plans to drop support for the existing upload API.</p>
<p>Unlike with <a class="pep reference internal" href="../pep-0691/" title="PEP 691 – JSON-based Simple API for Python Package Indexes">PEP 691</a> there are significant benefits to doing so, so it is likely that support for
the legacy upload API to be (responsibly) deprecated and removed at some point in the future.  Such
future deprecation planning is explicitly out of scope for <em>this</em> PEP.</p>
</section>
<section id="is-this-resumable-upload-protocol-based-on-anything">
<h3><a class="toc-backref" href="#is-this-resumable-upload-protocol-based-on-anything" role="doc-backlink">Is this Resumable Upload protocol based on anything?</a></h3>
<p>Yes!</p>
<p>It’s actually based on the protocol specified in an <a class="reference external" href="https://www.ietf.org/archive/id/draft-ietf-httpbis-resumable-upload-05.html">active internet draft</a>, where the
authors took what they learned implementing <a class="reference external" href="https://tus.io/">tus</a> to provide the idea of
resumable uploads in a wholly generic, standards based way.</p>
<p>This PEP deviates from that spec in several ways, as described in the body of the proposal.  This
decision was made for a few reasons:</p>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">104</span> <span class="pre">Upload</span> <span class="pre">Resumption</span> <span class="pre">Supported</span></code> is the only part of that draft which does not rely
entirely on things that are already supported in the existing standards, since it was adding a new
informational status.</li>
<li>Many clients and web frameworks don’t support <code class="docutils literal notranslate"><span class="pre">1xx</span></code> informational responses in a very good way,
if at all, adding it would complicate implementation for very little benefit.</li>
<li>The purpose of the <code class="docutils literal notranslate"><span class="pre">104</span> <span class="pre">Upload</span> <span class="pre">Resumption</span> <span class="pre">Supported</span></code> support is to allow clients to determine
that an arbitrary endpoint that they’re interacting with supports resumable uploads. Since this
PEP is mandating support for that in servers, clients can just assume that the server they are
interacting with supports it, which makes using it unneeded.</li>
<li>In theory, if the support for <code class="docutils literal notranslate"><span class="pre">1xx</span></code> responses got resolved and the draft gets accepted with it
in, we can add that in at a later date without changing the overall flow of the API.</li>
</ul>
</section>
<section id="can-i-use-the-upload-2-0-api-to-reserve-a-project-name">
<h3><a class="toc-backref" href="#can-i-use-the-upload-2-0-api-to-reserve-a-project-name" role="doc-backlink">Can I use the upload 2.0 API to reserve a project name?</a></h3>
<p>Yes!  If you’re not ready to upload files to make a release, you can still reserve a project
name (assuming of course that the name doesn’t already exist).</p>
<p>To do this, <a class="reference internal" href="#session-create"><span class="std std-ref">create a new session</span></a>, then <a class="reference internal" href="#publish-session"><span class="std std-ref">publish the session</span></a> without uploading any files.  While the <code class="docutils literal notranslate"><span class="pre">version</span></code> key is required in the JSON
body of the create session request, you can simply use the placeholder version number <code class="docutils literal notranslate"><span class="pre">&quot;0.0.0&quot;</span></code>.</p>
<p>The user that created the session will become the owner of the new project.</p>
</section>
</section>
<section id="open-questions">
<h2><a class="toc-backref" href="#open-questions" role="doc-backlink">Open Questions</a></h2>
<section id="multipart-uploads-vs-tus">
<h3><a class="toc-backref" href="#multipart-uploads-vs-tus" role="doc-backlink">Multipart Uploads vs tus</a></h3>
<p>This PEP currently bases the actual uploading of files on an <a class="reference external" href="https://www.ietf.org/archive/id/draft-ietf-httpbis-resumable-upload-05.html">internet draft</a>
(originally designed by <a class="reference external" href="https://tus.io/">tus.io</a>) that supports resumable file uploads.</p>
<p>That protocol requires a few things:</p>
<ul class="simple">
<li>That if clients don’t upload the entire file in one shot, that they have to submit the chunks
serially, and in the correct order, with all but the final chunk having a <code class="docutils literal notranslate"><span class="pre">Upload-Complete:</span> <span class="pre">?0</span></code>
header.</li>
<li>Resumption of an upload is essentially just querying the server to see how much data they’ve
gotten, then sending the remaining bytes (either as a single request, or in chunks).</li>
<li>The upload implicitly is completed when the server successfully gets all of the data from the
client.</li>
</ul>
<p>This has the benefit that if a client doesn’t care about resuming their download, it can essentially
ignore the protocol.  Clients can just <code class="docutils literal notranslate"><span class="pre">POST</span></code> the file to the file upload URL, and if it doesn’t
succeed, they can just <code class="docutils literal notranslate"><span class="pre">POST</span></code> the whole file again.</p>
<p>The other benefit is that even if clients do want to support resumption, unless they <em>need</em> to
resume the download, they can still just <code class="docutils literal notranslate"><span class="pre">POST</span></code> the file.</p>
<p>Another, possibly theoretical benefit is that for hashing the uploaded files, the serial chunks
requirement means that the server can maintain hashing state between requests, update it for each
request, then write that file back to storage. Unfortunately this isn’t actually possible to do with
Python’s <a class="reference external" href="https://docs.python.org/3/library/hashlib.html">hashlib</a> standard library module.
There are some libraries third party libraries, such as <a class="reference external" href="https://rehash.readthedocs.io/en/latest/">Rehash</a> that do implement the necessary APIs, but they don’t
support every hash that <code class="docutils literal notranslate"><span class="pre">hashlib</span></code> does (e.g. <code class="docutils literal notranslate"><span class="pre">blake2</span></code> or <code class="docutils literal notranslate"><span class="pre">sha3</span></code> at the time of writing).</p>
<p>We might also need to reconstitute the download for processing anyways to do things like extract
metadata, etc from it, which would make it a moot point.</p>
<p>The downside is that there is no ability to parallelize the upload of a single file because each
chunk has to be submitted serially.</p>
<p>AWS S3 has a similar API, and most blob stores have copied it either wholesale or something like it
which they call multipart uploading.</p>
<p>The basic flow for a multipart upload is:</p>
<ol class="arabic simple">
<li>Initiate a multipart upload to get an upload ID.</li>
<li>Break your file up into chunks, and upload each one of them individually.</li>
<li>Once all chunks have been uploaded, finalize the upload. This is the step where any errors would
occur.</li>
</ol>
<p>Such multipart uploads do not directly support resuming an upload, but it allows clients to control
the “blast radius” of failure by adjusting the size of each part they upload, and if any of the
parts fail, they only have to resend those specific parts.  The trade-off is that it allows for more
parallelism when uploading a single file, allowing clients to maximize their bandwidth using
multiple threads to send the file data.</p>
<p>We wouldn’t need an explicit step (1), because our session would implicitly initiate a multipart
upload for each file.</p>
<p>There are downsides to this though:</p>
<ul class="simple">
<li>Clients have to do more work on every request to have something resembling resumable uploads. They
would <em>have</em> to break the file up into multiple parts rather than just making a single POST
request, and only needing to deal with the complexity if something fails.</li>
<li>Clients that don’t care about resumption at all still have to deal with the third explicit step,
though they could just upload the file all as a single part. (S3 works around this by having
another API for one shot uploads, but the PEP authors place a high value on having a single API
for uploading any individual file.)</li>
<li>Verifying hashes gets somewhat more complicated. AWS implements hashing multipart uploads by
hashing each part, then the overall hash is just a hash of those hashes, not of the content
itself.  Since PyPI needs to know the actual hash of the file itself anyway, we would have to
reconstitute the file, read its content, and hash it once it’s been fully uploaded, though it
could still use the hash of hashes trick for checksumming the upload itself.</li>
</ul>
<p>The PEP authors lean towards <code class="docutils literal notranslate"><span class="pre">tus</span></code> style resumable uploads, due to them being simpler to use,
easier to imp;lement, and more consistent, with the main downside being that multi-threaded
performance is theoretically left on the table.</p>
<p>One other possible benefit of the S3 style multipart uploads is that you don’t have to try and do
any sort of protection against parallel uploads, since they’re just supported. That alone might
erase most of the server side implementation simplification.</p>
<p class="rubric">Footnotes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="fn-action" role="doc-footnote">
<dt class="label" id="fn-action">[<a href="#id1">1</a>]</dt>
<dd>Obsolete <code class="docutils literal notranslate"><span class="pre">:action</span></code> values <code class="docutils literal notranslate"><span class="pre">submit</span></code>, <code class="docutils literal notranslate"><span class="pre">submit_pkg_info</span></code>, and <code class="docutils literal notranslate"><span class="pre">doc_upload</span></code> are
no longer supported</aside>
<aside class="footnote brackets" id="fn-metadata" role="doc-footnote">
<dt class="label" id="fn-metadata">[<a href="#id2">2</a>]</dt>
<dd>This would be fine if used as a pre-check, but the parallel metadata should be
validated against the actual <code class="docutils literal notranslate"><span class="pre">METADATA</span></code> or similar files within the
distribution.</aside>
<aside class="footnote brackets" id="fn-hash" role="doc-footnote">
<dt class="label" id="fn-hash">[<a href="#id5">3</a>]</dt>
<dd>Specifically any hash algorithm name that <a class="reference external" href="https://docs.python.org/3/library/hashlib.html#hashlib.new">can be passed to</a> <code class="docutils literal notranslate"><span class="pre">hashlib.new()</span></code> and
which does not require additional parameters.</aside>
<aside class="footnote brackets" id="fn-immutable" role="doc-footnote">
<dt class="label" id="fn-immutable">[<a href="#id7">4</a>]</dt>
<dd>Published files may still be yanked (i.e. <a class="pep reference internal" href="../pep-0592/" title="PEP 592 – Adding “Yank” Support to the Simple API">PEP 592</a>) or <a class="reference external" href="https://pypi.org/help/#file-name-reuse">deleted</a> as normal.</aside>
<aside class="footnote brackets" id="fn-location" role="doc-footnote">
<dt class="label" id="fn-location">[<a href="#id6">5</a>]</dt>
<dd>Or the URL given in the <code class="docutils literal notranslate"><span class="pre">Location</span></code> header in the response to the file upload
initiation request, i.e. the metadata upload request; both of these links <strong>MUST</strong>
be the same.</aside>
</aside>
</section>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/peps/pep-0694.rst">https://github.com/python/peps/blob/main/peps/pep-0694.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/peps/pep-0694.rst">2025-01-06 23:53:01 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#legacy-api">Legacy API</a><ul>
<li><a class="reference internal" href="#endpoint">Endpoint</a></li>
<li><a class="reference internal" href="#encoding">Encoding</a></li>
<li><a class="reference internal" href="#content">Content</a></li>
<li><a class="reference internal" href="#authentication">Authentication</a></li>
</ul>
</li>
<li><a class="reference internal" href="#upload-2-0-api-specification">Upload 2.0 API Specification</a><ul>
<li><a class="reference internal" href="#versioning">Versioning</a></li>
<li><a class="reference internal" href="#root-endpoint">Root Endpoint</a><ul>
<li><a class="reference internal" href="#create-an-upload-session">Create an Upload Session</a><ul>
<li><a class="reference internal" href="#response-body">Response Body</a></li>
<li><a class="reference internal" href="#session-links">Session Links</a></li>
<li><a class="reference internal" href="#session-files">Session Files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#file-upload">File Upload</a><ul>
<li><a class="reference internal" href="#upload-file-contents">Upload File Contents</a></li>
<li><a class="reference internal" href="#resume-an-upload">Resume an Upload</a></li>
<li><a class="reference internal" href="#canceling-an-in-progress-upload">Canceling an In-Progress Upload</a></li>
<li><a class="reference internal" href="#delete-a-partial-or-fully-uploaded-file">Delete a Partial or Fully Uploaded File</a></li>
<li><a class="reference internal" href="#replacing-a-partially-or-fully-uploaded-file">Replacing a Partially or Fully Uploaded File</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-status">Session Status</a></li>
<li><a class="reference internal" href="#session-extension">Session Extension</a></li>
<li><a class="reference internal" href="#session-cancellation">Session Cancellation</a></li>
<li><a class="reference internal" href="#session-completion">Session Completion</a></li>
<li><a class="reference internal" href="#session-token">Session Token</a></li>
<li><a class="reference internal" href="#stage-previews">Stage Previews</a></li>
</ul>
</li>
<li><a class="reference internal" href="#errors">Errors</a></li>
<li><a class="reference internal" href="#content-types">Content Types</a></li>
</ul>
</li>
<li><a class="reference internal" href="#faq">FAQ</a><ul>
<li><a class="reference internal" href="#does-this-mean-pypi-is-planning-to-drop-support-for-the-existing-upload-api">Does this mean PyPI is planning to drop support for the existing upload API?</a></li>
<li><a class="reference internal" href="#is-this-resumable-upload-protocol-based-on-anything">Is this Resumable Upload protocol based on anything?</a></li>
<li><a class="reference internal" href="#can-i-use-the-upload-2-0-api-to-reserve-a-project-name">Can I use the upload 2.0 API to reserve a project name?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#open-questions">Open Questions</a><ul>
<li><a class="reference internal" href="#multipart-uploads-vs-tus">Multipart Uploads vs tus</a></li>
</ul>
</li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br>
            <a id="source" href="https://github.com/python/peps/blob/main/peps/pep-0694.rst">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
    <script src="../_static/sticky_banner.js"></script>
</body>
</html>